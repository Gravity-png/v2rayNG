name: åŒæ­¥Forkä¸ä¸Šæ¸¸ä»“åº“

on:
  schedule:
    - cron: "0 2 * * 2"   # æ¯å‘¨äºŒå‡Œæ™¨2ç‚¹æ‰§è¡Œï¼ˆé¿å¼€å‘¨æœ«é«˜å³°ï¼‰
  workflow_dispatch:
    inputs:
      force_sync:
        description: 'å¼ºåˆ¶åŒæ­¥ï¼ˆå¿½ç•¥åˆ é™¤ä¿æŠ¤ï¼‰'
        required: false
        default: 'false'
        type: boolean
      delete_files_threshold:
        description: 'åˆ é™¤æ–‡ä»¶æ•°é‡é˜ˆå€¼ (%)'
        required: false
        default: '40'
      readme_diff_threshold:
        description: 'README.md å·®å¼‚æ¯”ä¾‹é˜ˆå€¼ (%)'
        required: false
        default: '50'
      critical_files_threshold:
        description: 'å…³é”®æ„å»ºæ–‡ä»¶åˆ é™¤æ•°é‡é˜ˆå€¼'
        required: false
        default: '5'
      total_change_threshold:
        description: 'æ€»å˜åŒ–ç‡é˜ˆå€¼ (%)'
        required: false
        default: '60'
      code_lines_threshold:
        description: 'ä»£ç æ€»å˜åŒ–è¡Œæ•°é˜ˆå€¼'
        required: false
        default: '2000'

env:
  DELETE_FILES_THRESHOLD: ${{ github.event.inputs.delete_files_threshold || '40' }}
  README_DIFF_THRESHOLD: ${{ github.event.inputs.readme_diff_threshold || '50' }}
  CRITICAL_FILES_THRESHOLD: ${{ github.event.inputs.critical_files_threshold || '5' }}
  TOTAL_CHANGE_THRESHOLD: ${{ github.event.inputs.total_change_threshold || '60' }}
  CODE_LINES_THRESHOLD: ${{ github.event.inputs.code_lines_threshold || '2000' }}
  UPSTREAM_REPO: "2dust/v2rayNG"  # ä¿®æ”¹ä¸ºä½ çš„ä¸Šæ¸¸ä»“åº“

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºForkä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: é…ç½®Gitç”¨æˆ·ä¿¡æ¯
        run: |
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'

      - name: éªŒè¯Forkå…³ç³»å’Œä¸Šæ¸¸ä»“åº“
        id: validate_repos
        run: |
          echo "===== ğŸ” éªŒè¯ä»“åº“å…³ç³» ====="
          
          CURRENT_REPO="${{ github.repository }}"
          UPSTREAM_REPO="${{ env.UPSTREAM_REPO }}"
          
          echo "ğŸ“Œ å½“å‰ä»“åº“: $CURRENT_REPO"
          echo "ğŸ“ é…ç½®çš„ä¸Šæ¸¸: $UPSTREAM_REPO"
          echo ""
          
          # è·å–å½“å‰ä»“åº“ä¿¡æ¯ï¼ˆä¸ä½¿ç”¨tokenï¼Œé¿å…é€Ÿç‡é™åˆ¶ï¼‰
          echo "æ­£åœ¨è·å–ä»“åº“ä¿¡æ¯..."
          FORK_INFO=$(curl -s "https://api.github.com/repos/$CURRENT_REPO")
          
          # æ£€æŸ¥æ˜¯å¦æ˜¯Forkï¼ˆä½¿ç”¨grepæ›¿ä»£jqï¼Œæ›´é€šç”¨ï¼‰
          IS_FORK=$(echo "$FORK_INFO" | grep -o '"fork":[^,]*' | cut -d: -f2 | tr -d ' "')
          
          if [[ "$IS_FORK" == "true" ]]; then
            echo "âœ… å½“å‰ä»“åº“æ˜¯Forkä»“åº“"
            
            # è·å–çˆ¶ä»“åº“ä¿¡æ¯
            PARENT_REPO=$(echo "$FORK_INFO" | grep -o '"parent":{[^}]*"full_name":"[^"]*"' | \
                          grep -o '"full_name":"[^"]*"' | cut -d'"' -f4)
            
            if [[ -n "$PARENT_REPO" ]]; then
              echo "ğŸ”— å®é™…Forkæº: $PARENT_REPO"
              
              # æ£€æŸ¥é…ç½®æ˜¯å¦åŒ¹é…
              if [[ "$PARENT_REPO" != "$UPSTREAM_REPO" ]]; then
                echo ""
                echo "::warning::âš ï¸ é…ç½®çš„ä¸Šæ¸¸ä¸å®é™…Forkæºä¸åŒ¹é…ï¼"
                echo "  å®é™…Forkæº: $PARENT_REPO"
                echo "  é…ç½®çš„ä¸Šæ¸¸: $UPSTREAM_REPO"
                echo ""
                
                if [[ "${{ github.event.inputs.force_sync }}" == "true" ]]; then
                  echo "ğŸ“Œ å¼ºåˆ¶åŒæ­¥æ¨¡å¼ï¼šå°†ä½¿ç”¨é…ç½®çš„ä¸Šæ¸¸ä»“åº“"
                  echo "âš ï¸ è­¦å‘Šï¼šè¿™å¯èƒ½å¯¼è‡´æ„å¤–çš„åŒæ­¥ç»“æœï¼"
                else
                  echo "::error::âŒ ä¸Šæ¸¸ä»“åº“é…ç½®é”™è¯¯ï¼"
                  echo ""
                  echo "è¯·ä¿®æ”¹ my-sync.yml ä¸­çš„ UPSTREAM_REPO ä¸ºï¼š"
                  echo "  UPSTREAM_REPO: \"$PARENT_REPO\""
                  echo ""
                  echo "æˆ–è€…ä½¿ç”¨ force_sync å‚æ•°å¼ºåˆ¶åŒæ­¥åˆ°é…ç½®çš„ä¸Šæ¸¸"
                  exit 1
                fi
              else
                echo "âœ… ä¸Šæ¸¸é…ç½®æ­£ç¡®"
              fi
            fi
          else
            echo "âš ï¸ å½“å‰ä»“åº“ä¸æ˜¯Fork"
            echo "å°†å°è¯•åŒæ­¥åˆ°é…ç½®çš„ä¸Šæ¸¸ä»“åº“..."
          fi
          
          # éªŒè¯ä¸Šæ¸¸ä»“åº“æ˜¯å¦å­˜åœ¨ä¸”å¯è®¿é—®
          echo ""
          echo "ğŸŒ éªŒè¯ä¸Šæ¸¸ä»“åº“å¯è®¿é—®æ€§..."
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
                        "https://api.github.com/repos/$UPSTREAM_REPO")
          
          if [[ "$HTTP_STATUS" == "200" ]]; then
            echo "âœ… ä¸Šæ¸¸ä»“åº“å­˜åœ¨ä¸”å¯è®¿é—®"
          elif [[ "$HTTP_STATUS" == "404" ]]; then
            echo "::error::âŒ ä¸Šæ¸¸ä»“åº“ä¸å­˜åœ¨: $UPSTREAM_REPO"
            echo "è¯·æ£€æŸ¥ä»“åº“åç§°æ˜¯å¦æ­£ç¡®"
            exit 1
          elif [[ "$HTTP_STATUS" == "403" ]]; then
            echo "::error::âŒ æ— æƒè®¿é—®ä¸Šæ¸¸ä»“åº“ï¼ˆå¯èƒ½æ˜¯ç§æœ‰ä»“åº“ï¼‰"
            exit 1
          else
            echo "::error::âŒ æ— æ³•è®¿é—®ä¸Šæ¸¸ä»“åº“ (HTTP $HTTP_STATUS)"
            exit 1
          fi
          
          echo ""
          echo "âœ… ä»“åº“éªŒè¯é€šè¿‡"
          echo "validation_passed=true" >> $GITHUB_OUTPUT

      - name: æ·»åŠ ä¸Šæ¸¸ä»“åº“å¹¶è·å–æ‰€æœ‰æ›´æ–°
        if: steps.validate_repos.outputs.validation_passed == 'true'
        run: |
          # æ·»åŠ æˆ–æ›´æ–°ä¸Šæ¸¸ä»“åº“
          if git remote get-url upstream >/dev/null 2>&1; then
            git remote set-url upstream https://github.com/${{ env.UPSTREAM_REPO }}.git
          else
            git remote add upstream https://github.com/${{ env.UPSTREAM_REPO }}.git
          fi
          
          # ä¸€æ¬¡æ€§è·å–æ‰€æœ‰éœ€è¦çš„å¼•ç”¨ï¼ˆé¿å…åç»­é‡å¤ fetchï¼‰
          echo "ğŸ“¥ è·å–ä¸Šæ¸¸å’Œoriginçš„æœ€æ–°ä»£ç ..."
          git fetch upstream
          git fetch origin

      - name: æ—©æœŸå·®å¼‚æ£€æµ‹
        id: early_diff_check
        if: steps.validate_repos.outputs.validation_passed == 'true'
        run: |
          echo "===== ğŸ” æ—©æœŸå·®å¼‚æ£€æµ‹ ====="
          
          # è·å–å½“å‰åˆ†æ”¯
          LOCAL_BRANCH=$(git branch --show-current)
          
          # è·å–ä¸Šæ¸¸é»˜è®¤åˆ†æ”¯
          UPSTREAM_BRANCH=$(git remote show upstream | grep "HEAD branch" | sed 's/.*: //')
          
          echo "æ¯”è¾ƒåˆ†æ”¯: $LOCAL_BRANCH â†” upstream/$UPSTREAM_BRANCH"
          echo ""
          
          # å¿«é€Ÿæ£€æŸ¥å…±åŒæ–‡ä»¶æ•°é‡
          echo "æ­£åœ¨åˆ†ææ–‡ä»¶ç›¸ä¼¼åº¦..."
          LOCAL_FILES=$(git ls-tree -r --name-only HEAD | sort)
          UPSTREAM_FILES=$(git ls-tree -r --name-only upstream/$UPSTREAM_BRANCH 2>/dev/null | sort)
          
          # è®¡ç®—å…±åŒæ–‡ä»¶
          COMMON_FILES=$(echo "$LOCAL_FILES" | comm -12 - <(echo "$UPSTREAM_FILES") | wc -l)
          TOTAL_LOCAL=$(echo "$LOCAL_FILES" | wc -l)
          TOTAL_UPSTREAM=$(echo "$UPSTREAM_FILES" | wc -l)
          
          echo "ğŸ“Š æ–‡ä»¶ç»Ÿè®¡ï¼š"
          echo "  æœ¬åœ°æ–‡ä»¶æ•°: $TOTAL_LOCAL"
          echo "  ä¸Šæ¸¸æ–‡ä»¶æ•°: $TOTAL_UPSTREAM"
          echo "  å…±åŒæ–‡ä»¶æ•°: $COMMON_FILES"
          
          # è®¡ç®—ç›¸ä¼¼åº¦
          if [[ $TOTAL_LOCAL -gt 0 ]]; then
            SIMILARITY=$((COMMON_FILES * 100 / TOTAL_LOCAL))
            echo "  ç›¸ä¼¼åº¦: ${SIMILARITY}%"
            
            # å¦‚æœç›¸ä¼¼åº¦ä½äº10%ï¼Œå¾ˆå¯èƒ½æ˜¯é”™è¯¯çš„ä¸Šæ¸¸
            if [[ $SIMILARITY -lt 10 ]]; then
              echo ""
              echo "::error::âŒ æ£€æµ‹åˆ°ä¸¥é‡å·®å¼‚ï¼"
              echo "ä¸Šæ¸¸ä»“åº“ä¸å½“å‰ä»“åº“å‡ ä¹æ²¡æœ‰å…±åŒæ–‡ä»¶ï¼ˆç›¸ä¼¼åº¦ä»… ${SIMILARITY}%ï¼‰"
              echo ""
              echo "å¯èƒ½çš„åŸå› ï¼š"
              echo "  1. é…ç½®äº†é”™è¯¯çš„ä¸Šæ¸¸ä»“åº“"
              echo "  2. è¿™ä¸¤ä¸ªä»“åº“æ˜¯å®Œå…¨ä¸åŒçš„é¡¹ç›®"
              echo "  3. ä¸Šæ¸¸é¡¹ç›®å·²ç»å®Œå…¨é‡å†™"
              echo ""
              
              if [[ "${{ github.event.inputs.force_sync }}" != "true" ]]; then
                echo "å¦‚æœç¡®è®¤é…ç½®æ— è¯¯ï¼Œè¯·ä½¿ç”¨ force_sync å‚æ•°å¼ºåˆ¶åŒæ­¥"
                exit 1
              else
                echo "âš ï¸ å¼ºåˆ¶åŒæ­¥æ¨¡å¼ï¼šå¿½ç•¥å·®å¼‚æ£€æŸ¥"
              fi
            elif [[ $SIMILARITY -lt 30 ]]; then
              echo ""
              echo "::warning::âš ï¸ ç›¸ä¼¼åº¦è¾ƒä½ (${SIMILARITY}%)ï¼Œè¯·ç¡®è®¤ä¸Šæ¸¸ä»“åº“é…ç½®æ­£ç¡®"
            else
              echo "âœ… æ–‡ä»¶ç›¸ä¼¼åº¦æ£€æŸ¥é€šè¿‡"
            fi
          fi
          
          echo "early_check_passed=true" >> $GITHUB_OUTPUT

      - name: è‡ªåŠ¨æ£€æµ‹é»˜è®¤åˆ†æ”¯
        id: detect_branches
        if: steps.early_diff_check.outputs.early_check_passed == 'true'
        run: |
          # è‡ªåŠ¨æ£€æµ‹ä¸Šæ¸¸çš„é»˜è®¤åˆ†æ”¯
          UPSTREAM_DEFAULT_BRANCH=$(git remote show upstream | grep "HEAD branch" | sed 's/.*: //' | tr -d '[:space:]')
          # è·å–æœ¬åœ°å½“å‰åˆ†æ”¯
          LOCAL_CURRENT_BRANCH=$(git branch --show-current | tr -d '[:space:]')
          
          if [[ -z "$UPSTREAM_DEFAULT_BRANCH" || -z "$LOCAL_CURRENT_BRANCH" ]]; then
            echo "âŒ æ— æ³•æ£€æµ‹åˆ†æ”¯"
            echo "  ä¸Šæ¸¸é»˜è®¤åˆ†æ”¯: ${UPSTREAM_DEFAULT_BRANCH:-æœªæ£€æµ‹åˆ°}"
            echo "  æœ¬åœ°å½“å‰åˆ†æ”¯: ${LOCAL_CURRENT_BRANCH:-æœªæ£€æµ‹åˆ°}"
            exit 1
          fi
          
          echo "ğŸ“Œ æ£€æµ‹åˆ°çš„åˆ†æ”¯ï¼š"
          echo "  ä¸Šæ¸¸é»˜è®¤åˆ†æ”¯: $UPSTREAM_DEFAULT_BRANCH"
          echo "  æœ¬åœ°å½“å‰åˆ†æ”¯: $LOCAL_CURRENT_BRANCH"
          
          echo "upstream_branch=$UPSTREAM_DEFAULT_BRANCH" >> $GITHUB_OUTPUT
          echo "local_branch=$LOCAL_CURRENT_BRANCH" >> $GITHUB_OUTPUT

      - name: æ£€æŸ¥æ˜¯å¦éœ€è¦åŒæ­¥
        id: check_sync_needed
        if: steps.early_diff_check.outputs.early_check_passed == 'true'
        run: |
          UPSTREAM_BRANCH="${{ steps.detect_branches.outputs.upstream_branch }}"
          LOCAL_BRANCH="${{ steps.detect_branches.outputs.local_branch }}"
          
          # æ¯”è¾ƒæœ¬åœ°å’Œä¸Šæ¸¸æ˜¯å¦æœ‰å·®å¼‚
          if git diff --quiet "origin/$LOCAL_BRANCH" "upstream/$UPSTREAM_BRANCH"; then
            echo "âœ… Fork å·²æ˜¯æœ€æ–°ï¼Œæ— éœ€åŒæ­¥"
            echo "needs_sync=false" >> $GITHUB_OUTPUT
            exit 0  # æå‰é€€å‡ºï¼ŒèŠ‚çœèµ„æº
          else
            echo "ğŸ”„ æ£€æµ‹åˆ°ä¸Šæ¸¸æœ‰æ›´æ–°ï¼Œéœ€è¦åŒæ­¥"
            echo "needs_sync=true" >> $GITHUB_OUTPUT
          fi

      - name: åˆå§‹åŒ–ä¿æŠ¤æ—¥å¿—
        id: init_protection_log
        if: steps.check_sync_needed.outputs.needs_sync == 'true'
        run: |
          mkdir -p /tmp/sync_logs
          LOG_FILE="/tmp/sync_logs/protection.log"
          echo "===== ğŸ›¡ï¸ åŒæ­¥ä¿æŠ¤æ—¥å¿— =====" > "$LOG_FILE"
          echo "æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')" >> "$LOG_FILE"
          echo "å½“å‰ä»“åº“: ${{ github.repository }}" >> "$LOG_FILE"
          echo "ä¸Šæ¸¸ä»“åº“: ${{ env.UPSTREAM_REPO }}" >> "$LOG_FILE"
          echo "================================" >> "$LOG_FILE"
          echo "" >> "$LOG_FILE"
          echo "log_file=$LOG_FILE" >> $GITHUB_OUTPUT

      - name: å¤‡ä»½ç”¨æˆ·è‡ªå®šä¹‰å·¥ä½œæµ
        id: backup_workflows
        if: steps.check_sync_needed.outputs.needs_sync == 'true'
        run: |
          BACKUP_DIR="/tmp/my_workflows_backup"
          mkdir -p "$BACKUP_DIR"
          LOG_FILE="${{ steps.init_protection_log.outputs.log_file }}"
          
          # å®šä¹‰æ—¥å¿—å‡½æ•°
          log() { echo "$@" | tee -a "$LOG_FILE"; }
          
          log "ğŸ“¦ å¼€å§‹å¤‡ä»½ç”¨æˆ·è‡ªå®šä¹‰å·¥ä½œæµ..."
          BACKUP_COUNT=0
          
          # åªå¤‡ä»½ my-*.yml æ–‡ä»¶
          if [[ -d ".github/workflows" ]]; then
            for FILE in .github/workflows/my-*.yml .github/workflows/my-*.yaml; do
              if [[ -f "$FILE" ]]; then
                FILENAME=$(basename "$FILE")
                cp -p "$FILE" "$BACKUP_DIR/$FILENAME"
                BACKUP_COUNT=$((BACKUP_COUNT + 1))
                log "  å¤‡ä»½: $FILENAME"
              fi
            done
          fi
          
          if [[ $BACKUP_COUNT -gt 0 ]]; then
            log "ğŸ“¦ å·²å¤‡ä»½ $BACKUP_COUNT ä¸ªç”¨æˆ·è‡ªå®šä¹‰å·¥ä½œæµ"
          else
            log "â„¹ï¸ æ²¡æœ‰å‘ç°ç”¨æˆ·è‡ªå®šä¹‰å·¥ä½œæµ (my-*.yml)"
          fi
          
          echo "backup_count=$BACKUP_COUNT" >> $GITHUB_OUTPUT
          echo "backup_dir=$BACKUP_DIR" >> $GITHUB_OUTPUT

      - name: æ™ºèƒ½åˆ†æä¸Šæ¸¸å˜æ›´å¹¶è¿›è¡Œå®‰å…¨æ£€æŸ¥
        id: analyze_changes
        if: steps.check_sync_needed.outputs.needs_sync == 'true'
        run: |
          UPSTREAM_BRANCH="${{ steps.detect_branches.outputs.upstream_branch }}"
          LOCAL_BRANCH="${{ steps.detect_branches.outputs.local_branch }}"
          LOG_FILE="${{ steps.init_protection_log.outputs.log_file }}"
          
          # å®šä¹‰æ—¥å¿—å‡½æ•°
          log() { echo "$@" | tee -a "$LOG_FILE"; }
          log_error() { echo "âŒ $@" | tee -a "$LOG_FILE" >&2; }
          log_warning() { echo "âš ï¸ $@" | tee -a "$LOG_FILE"; }
          log_success() { echo "âœ… $@" | tee -a "$LOG_FILE"; }
          
          # å…³é”®æ„å»ºæ–‡ä»¶çš„æ­£åˆ™è¡¨è¾¾å¼
          CRITICAL_PATTERNS_REGEX="(Dockerfile|docker-compose.*\.(yml|yaml)|Makefile|CMakeLists\.txt|.*\.gradle(\.kts)?|gradle\.properties|settings\.gradle|AndroidManifest\.xml|pom\.xml|package(-lock)?\.json|yarn\.lock|electron-builder\.yml|app\.json|.*\.csproj|Cargo\.(toml|lock)|go\.(mod|sum)|requirements\.txt|Pipfile(\.lock)?|pyproject\.toml|setup\.(py|cfg)|\.github/workflows/.*\.(yml|yaml))"
          
          # åˆ›å»ºä¸´æ—¶æ–‡ä»¶
          LOCAL_FILES_TMP=$(mktemp)
          UPSTREAM_FILES_TMP=$(mktemp)
          DELETED_FILES_TMP=$(mktemp)
          ADDED_FILES_TMP=$(mktemp)
          
          # è®¾ç½®æ¸…ç† trap
          trap 'rm -f "$LOCAL_FILES_TMP" "$UPSTREAM_FILES_TMP" "$DELETED_FILES_TMP" "$ADDED_FILES_TMP"' EXIT
          
          log "===== ğŸ“Š å¼€å§‹åˆ†æå˜æ›´ ====="
          
          # å¹¶è¡Œè·å–æ–‡ä»¶åˆ—è¡¨ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰
          log "æ­£åœ¨è·å–æ–‡ä»¶åˆ—è¡¨..."
          git ls-tree -r --name-only "origin/$LOCAL_BRANCH" | sort > "$LOCAL_FILES_TMP" &
          git ls-tree -r --name-only "upstream/$UPSTREAM_BRANCH" | sort > "$UPSTREAM_FILES_TMP" &
          wait  # ç­‰å¾…ä¸¤ä¸ªåå°è¿›ç¨‹å®Œæˆ
          
          # è®¡ç®—æ–‡ä»¶æ€»æ•°
          TOTAL_LOCAL_FILES=$(wc -l < "$LOCAL_FILES_TMP")
          TOTAL_UPSTREAM_FILES=$(wc -l < "$UPSTREAM_FILES_TMP")
          
          # è®¡ç®—åˆ é™¤çš„æ–‡ä»¶ï¼ˆæœ¬åœ°æœ‰ä½†ä¸Šæ¸¸æ²¡æœ‰ï¼‰
          comm -23 "$LOCAL_FILES_TMP" "$UPSTREAM_FILES_TMP" > "$DELETED_FILES_TMP"
          DELETED_COUNT=$(wc -l < "$DELETED_FILES_TMP")
          
          # è®¡ç®—æ–°å¢çš„æ–‡ä»¶ï¼ˆä¸Šæ¸¸æœ‰ä½†æœ¬åœ°æ²¡æœ‰ï¼‰
          comm -13 "$LOCAL_FILES_TMP" "$UPSTREAM_FILES_TMP" > "$ADDED_FILES_TMP"
          ADDED_COUNT=$(wc -l < "$ADDED_FILES_TMP")
          
          # ä½¿ç”¨ git diff --diff-filter è·å–ä¿®æ”¹æ–‡ä»¶æ•°é‡ï¼ˆåŒ…æ‹¬é‡å‘½åï¼‰
          MODIFIED_COUNT=$(git diff --diff-filter=MR --name-only "origin/$LOCAL_BRANCH" "upstream/$UPSTREAM_BRANCH" | wc -l)
          
          # è®¡ç®—ä»£ç æ€»å˜åŒ–è¡Œæ•°
          log "æ­£åœ¨è®¡ç®—ä»£ç å˜åŒ–è¡Œæ•°..."
          TOTAL_LINES_CHANGED=$(git diff --numstat "origin/$LOCAL_BRANCH" "upstream/$UPSTREAM_BRANCH" | \
            awk '{added+=$1; deleted+=$2} END {print added+deleted}')
          
          # å¦‚æœè®¡ç®—å¤±è´¥ï¼Œè®¾ä¸º0
          if [[ -z "$TOTAL_LINES_CHANGED" ]]; then
            TOTAL_LINES_CHANGED=0
          fi
          
          # è·å–è¯¦ç»†çš„è¡Œæ•°ç»Ÿè®¡
          LINES_ADDED=$(git diff --numstat "origin/$LOCAL_BRANCH" "upstream/$UPSTREAM_BRANCH" | \
            awk '{sum+=$1} END {print sum}')
          LINES_DELETED=$(git diff --numstat "origin/$LOCAL_BRANCH" "upstream/$UPSTREAM_BRANCH" | \
            awk '{sum+=$2} END {print sum}')
          
          # å¤„ç†ç©ºå€¼
          LINES_ADDED=${LINES_ADDED:-0}
          LINES_DELETED=${LINES_DELETED:-0}
          
          # æ£€æŸ¥å…³é”®æ–‡ä»¶åˆ é™¤
          CRITICAL_DELETED=0
          CRITICAL_DELETED_FILES=""
          if [[ -s "$DELETED_FILES_TMP" ]]; then
            CRITICAL_DELETED=$(grep -E "$CRITICAL_PATTERNS_REGEX" "$DELETED_FILES_TMP" 2>/dev/null | wc -l)
            
            if [[ $CRITICAL_DELETED -gt 0 ]]; then
              CRITICAL_DELETED_FILES=$(grep -E "$CRITICAL_PATTERNS_REGEX" "$DELETED_FILES_TMP" 2>/dev/null | sed 's/^/\n  - /')
              grep -E "$CRITICAL_PATTERNS_REGEX" "$DELETED_FILES_TMP" 2>/dev/null | while read -r file; do
                log_warning "å…³é”®æ„å»ºæ–‡ä»¶è¢«åˆ é™¤: $file"
              done
            fi
          fi
          
          # ç‰¹åˆ«æ£€æŸ¥å·¥ä½œæµå˜æ›´
          log ""
          log "ğŸ” æ£€æŸ¥å·¥ä½œæµå˜æ›´..."
          WORKFLOW_CHANGES=$(git diff --name-only "origin/$LOCAL_BRANCH" "upstream/$UPSTREAM_BRANCH" | grep -E "^\.github/workflows/" || true)
          if [[ -n "$WORKFLOW_CHANGES" ]]; then
            log "å·¥ä½œæµæ–‡ä»¶å˜æ›´:"
            echo "$WORKFLOW_CHANGES" | while read -r file; do
              STATUS=$(git diff --name-status "origin/$LOCAL_BRANCH" "upstream/$UPSTREAM_BRANCH" -- "$file" | cut -f1)
              case $STATUS in
                A) log "  + $file (æ–°å¢)" ;;
                D) log "  - $file (åˆ é™¤)" ;;
                M) log "  ~ $file (ä¿®æ”¹)" ;;
                R*) log "  â†’ $file (é‡å‘½å)" ;;
              esac
            done
            log "ğŸ’¡ æç¤º: my-*.yml å·¥ä½œæµå°†è¢«ä¿æŠ¤ï¼Œå…¶ä»–å·¥ä½œæµå°†è·Ÿéšä¸Šæ¸¸æ›´æ–°"
          else
            log "  æ— å·¥ä½œæµå˜æ›´"
          fi
          
          # è®¡ç®—å„ç§æ¯”ç‡
          DELETE_RATIO=0
          CHANGE_RATIO=0
          NET_CHANGE_RATIO=0
          
          if (( TOTAL_LOCAL_FILES > 0 )); then
            DELETE_RATIO=$((DELETED_COUNT * 100 / TOTAL_LOCAL_FILES))
            CHANGE_RATIO=$(((DELETED_COUNT + MODIFIED_COUNT) * 100 / TOTAL_LOCAL_FILES))
            NET_CHANGE_RATIO=$(((ADDED_COUNT - DELETED_COUNT) * 100 / TOTAL_LOCAL_FILES))
          fi
          
          # æ£€æŸ¥ README å·®å¼‚
          README_CHANGE_PERCENT=0
          if [[ -f "README.md" ]]; then
            log "æ­£åœ¨æ£€æŸ¥ README.md å·®å¼‚..."
            # è·å–ä¸Šæ¸¸çš„ README å†…å®¹
            UPSTREAM_README=$(git show "upstream/$UPSTREAM_BRANCH:README.md" 2>/dev/null || echo "")
            
            if [[ -n "$UPSTREAM_README" ]]; then
              # ä¿å­˜åˆ°ä¸´æ—¶æ–‡ä»¶è¿›è¡Œæ¯”è¾ƒ
              echo "$UPSTREAM_README" > /tmp/upstream_readme.md
              
              # ä½¿ç”¨ git diff --no-index è®¡ç®—å·®å¼‚
              DIFF_STATS=$(git diff --no-index --numstat "README.md" "/tmp/upstream_readme.md" 2>/dev/null || echo "0 0")
              README_ADDED=$(echo "$DIFF_STATS" | awk '{print $1}')
              README_DELETED=$(echo "$DIFF_STATS" | awk '{print $2}')
              README_TOTAL_CHANGES=$((README_ADDED + README_DELETED))
              
              # è®¡ç®—åŸå§‹ README çš„è¡Œæ•°
              ORIGINAL_LINES=$(wc -l < "README.md")
              
              # è®¡ç®—å˜åŒ–ç™¾åˆ†æ¯”
              if (( ORIGINAL_LINES > 0 )); then
                README_CHANGE_PERCENT=$((README_TOTAL_CHANGES * 100 / ORIGINAL_LINES))
              else
                README_CHANGE_PERCENT=100
              fi
              
              log "  README.md å˜åŒ–: ${README_CHANGE_PERCENT}% (+${README_ADDED}/-${README_DELETED} è¡Œ)"
              
              # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
              rm -f /tmp/upstream_readme.md
            fi
          fi
          
          # è¾“å‡ºè¯¦ç»†çš„å˜æ›´åˆ†ææŠ¥å‘Š
          log ""
          log "===== ğŸ“Š å˜æ›´åˆ†ææŠ¥å‘Š ====="
          log "ğŸ“ æ–‡ä»¶ç»Ÿè®¡:"
          log "  æœ¬åœ°æ–‡ä»¶æ€»æ•°: $TOTAL_LOCAL_FILES"
          log "  ä¸Šæ¸¸æ–‡ä»¶æ€»æ•°: $TOTAL_UPSTREAM_FILES"
          log ""
          log "ğŸ“ˆ å˜æ›´è¯¦æƒ…:"
          log "  åˆ é™¤æ–‡ä»¶æ•°: $DELETED_COUNT (${DELETE_RATIO}%)"
          log "  æ–°å¢æ–‡ä»¶æ•°: $ADDED_COUNT"
          log "  ä¿®æ”¹æ–‡ä»¶æ•°: $MODIFIED_COUNT (å«é‡å‘½å)"
          log "  å…³é”®æ–‡ä»¶åˆ é™¤: $CRITICAL_DELETED"
          if [[ -n "$CRITICAL_DELETED_FILES" ]]; then
            log "  åˆ é™¤çš„å…³é”®æ–‡ä»¶:$CRITICAL_DELETED_FILES"
          fi
          log ""
          log "ğŸ“ ä»£ç è¡Œæ•°å˜åŒ–:"
          log "  æ–°å¢è¡Œæ•°: +$LINES_ADDED"
          log "  åˆ é™¤è¡Œæ•°: -$LINES_DELETED"
          log "  æ€»å˜åŒ–è¡Œæ•°: $TOTAL_LINES_CHANGED"
          log ""
          log "ğŸ“„ README.md å˜åŒ–:"
          log "  å˜åŒ–æ¯”ä¾‹: ${README_CHANGE_PERCENT}%"
          log ""
          log "ğŸ“Š å˜åŒ–ç‡:"
          log "  æ€»å˜åŒ–ç‡: ${CHANGE_RATIO}%"
          log "  å‡€å˜åŒ–ç‡: ${NET_CHANGE_RATIO}%"
          log "=========================="
          
          # è¾“å‡ºåˆ° GitHub è¾“å‡º
          echo "deleted_count=$DELETED_COUNT" >> $GITHUB_OUTPUT
          echo "added_count=$ADDED_COUNT" >> $GITHUB_OUTPUT
          echo "modified_count=$MODIFIED_COUNT" >> $GITHUB_OUTPUT
          echo "delete_ratio=$DELETE_RATIO" >> $GITHUB_OUTPUT
          echo "change_ratio=$CHANGE_RATIO" >> $GITHUB_OUTPUT
          echo "critical_deleted=$CRITICAL_DELETED" >> $GITHUB_OUTPUT
          echo "lines_changed=$TOTAL_LINES_CHANGED" >> $GITHUB_OUTPUT
          echo "lines_added=$LINES_ADDED" >> $GITHUB_OUTPUT
          echo "lines_deleted=$LINES_DELETED" >> $GITHUB_OUTPUT
          echo "readme_change_percent=$README_CHANGE_PERCENT" >> $GITHUB_OUTPUT
          
          # å†³ç­–é€»è¾‘ï¼ˆ5ä¸ªé˜ˆå€¼åˆ¤æ–­ï¼‰
          SAFE_TO_SYNC=true
          BLOCK_REASONS=""
          
          if [[ "${{ github.event.inputs.force_sync }}" != "true" ]]; then
            # é˜ˆå€¼1: å…³é”®æ–‡ä»¶åˆ é™¤æ•°é‡æ£€æŸ¥
            if (( CRITICAL_DELETED > ${{ env.CRITICAL_FILES_THRESHOLD }} )); then
              SAFE_TO_SYNC=false
              BLOCK_REASONS="${BLOCK_REASONS}\n  - åˆ é™¤äº† $CRITICAL_DELETED ä¸ªå…³é”®æ„å»ºæ–‡ä»¶ï¼ˆé˜ˆå€¼: ${{ env.CRITICAL_FILES_THRESHOLD }}ï¼‰"
            elif (( CRITICAL_DELETED > 0 )); then
              log_warning "è­¦å‘Š: æœ‰ $CRITICAL_DELETED ä¸ªå…³é”®æ–‡ä»¶è¢«åˆ é™¤ï¼Œä½†åœ¨å¯æ¥å—èŒƒå›´å†…"
            fi
            
            # é˜ˆå€¼2: åˆ é™¤æ–‡ä»¶æ¯”ä¾‹æ£€æŸ¥
            if (( DELETE_RATIO > ${{ env.DELETE_FILES_THRESHOLD }} )); then
              SAFE_TO_SYNC=false
              BLOCK_REASONS="${BLOCK_REASONS}\n  - åˆ é™¤æ–‡ä»¶æ¯”ä¾‹è¿‡é«˜: ${DELETE_RATIO}%ï¼ˆé˜ˆå€¼: ${{ env.DELETE_FILES_THRESHOLD }}%ï¼‰"
            fi
            
            # é˜ˆå€¼3: æ€»å˜åŒ–ç‡æ£€æŸ¥
            if (( CHANGE_RATIO > ${{ env.TOTAL_CHANGE_THRESHOLD }} )); then
              SAFE_TO_SYNC=false
              BLOCK_REASONS="${BLOCK_REASONS}\n  - é¡¹ç›®å˜åŒ–è¿‡å¤§: ${CHANGE_RATIO}%ï¼ˆé˜ˆå€¼: ${{ env.TOTAL_CHANGE_THRESHOLD }}%ï¼‰"
            fi
            
            # é˜ˆå€¼4: README å·®å¼‚æ£€æŸ¥
            if (( README_CHANGE_PERCENT > ${{ env.README_DIFF_THRESHOLD }} )); then
              SAFE_TO_SYNC=false
              BLOCK_REASONS="${BLOCK_REASONS}\n  - README.md å·®å¼‚è¿‡å¤§: ${README_CHANGE_PERCENT}%ï¼ˆé˜ˆå€¼: ${{ env.README_DIFF_THRESHOLD }}%ï¼‰"
            fi
            
            # é˜ˆå€¼5: ä»£ç è¡Œæ•°å˜åŒ–æ£€æŸ¥
            if (( TOTAL_LINES_CHANGED > ${{ env.CODE_LINES_THRESHOLD }} )); then
              SAFE_TO_SYNC=false
              BLOCK_REASONS="${BLOCK_REASONS}\n  - ä»£ç å˜åŒ–è¡Œæ•°è¿‡å¤š: $TOTAL_LINES_CHANGED è¡Œï¼ˆé˜ˆå€¼: ${{ env.CODE_LINES_THRESHOLD }} è¡Œï¼‰"
              BLOCK_REASONS="${BLOCK_REASONS}\n    â€¢ æ–°å¢: +$LINES_ADDED è¡Œ"
              BLOCK_REASONS="${BLOCK_REASONS}\n    â€¢ åˆ é™¤: -$LINES_DELETED è¡Œ"
            fi
            
            # é¢å¤–æ£€æŸ¥: é¡¹ç›®é‡æ„æ£€æµ‹
            if (( DELETED_COUNT > 100 && ADDED_COUNT > 100 )); then
              SAFE_TO_SYNC=false
              BLOCK_REASONS="${BLOCK_REASONS}\n  - æ£€æµ‹åˆ°å¯èƒ½çš„é¡¹ç›®é‡æ„ï¼ˆåˆ é™¤: $DELETED_COUNT, æ–°å¢: $ADDED_COUNTï¼‰"
            fi
            
            # é¢å¤–æ£€æŸ¥: å•æ¬¡æäº¤ä»£ç é‡å¼‚å¸¸
            if (( LINES_ADDED > 5000 )); then
              SAFE_TO_SYNC=false
              BLOCK_REASONS="${BLOCK_REASONS}\n  - å•æ¬¡æ–°å¢ä»£ç é‡å¼‚å¸¸: +$LINES_ADDED è¡Œï¼ˆå¯èƒ½å­˜åœ¨æ¶æ„ä»£ç æ³¨å…¥ï¼‰"
            fi
          else
            log_warning "å¼ºåˆ¶åŒæ­¥æ¨¡å¼å·²å¯ç”¨ï¼Œè·³è¿‡æ‰€æœ‰å®‰å…¨æ£€æŸ¥"
          fi
          
          # è¾“å‡ºå†³ç­–ç»“æœ
          if [[ "$SAFE_TO_SYNC" == "true" ]]; then
            log ""
            log_success "åˆ†æç»“æœ: å¯ä»¥å®‰å…¨åŒæ­¥"
            echo "safe_to_sync=true" >> $GITHUB_OUTPUT
            echo "::notice::âœ… å®‰å…¨æ£€æŸ¥é€šè¿‡ï¼Œå°†æ‰§è¡ŒåŒæ­¥"
          else
            log ""
            log_error "åˆ†æç»“æœ: ä¸å»ºè®®è‡ªåŠ¨åŒæ­¥"
            log "åŸå› :"
            echo -e "$BLOCK_REASONS" | tee -a "$LOG_FILE"
            log ""
            log "ğŸ’¡ å»ºè®®: è¯·æ‰‹åŠ¨æ£€æŸ¥ä¸Šæ¸¸å˜æ›´ï¼Œæˆ–ä½¿ç”¨ force_sync å‚æ•°å¼ºåˆ¶åŒæ­¥"
            echo "safe_to_sync=false" >> $GITHUB_OUTPUT
            echo "block_reason=åŒæ­¥è¢«æ™ºèƒ½ä¿æŠ¤é˜»æ­¢ï¼Œè¯¦è§æ—¥å¿—" >> $GITHUB_OUTPUT
            echo "::warning::âš ï¸ åŒæ­¥è¢«å®‰å…¨ä¿æŠ¤é˜»æ­¢ï¼Œè¯·æŸ¥çœ‹è¯¦ç»†æ—¥å¿—"
          fi
          
          # ç”Ÿæˆå˜æ›´æ‘˜è¦
          log ""
          log "===== ğŸ“ å˜æ›´æ‘˜è¦ ====="
          log "æœ€è¿‘5ä¸ªä¸Šæ¸¸æäº¤:"
          git log --oneline -5 "upstream/$UPSTREAM_BRANCH" | tee -a "$LOG_FILE"
          
          log ""
          log "ä¸»è¦å˜æ›´æ–‡ä»¶ç±»å‹ (å‰10):"
          git diff --name-only "origin/$LOCAL_BRANCH" "upstream/$UPSTREAM_BRANCH" | \
            sed 's/.*\.//' | sort | uniq -c | sort -rn | head -10 | tee -a "$LOG_FILE"
          
          log ""
          log "å—å½±å“çš„ç›®å½• (å‰10):"
          git diff --name-only "origin/$LOCAL_BRANCH" "upstream/$UPSTREAM_BRANCH" | \
            xargs -I {} dirname {} | sort | uniq -c | sort -rn | head -10 | tee -a "$LOG_FILE"
          
          # æ˜¾ç¤ºä»£ç é‡æœ€å¤§çš„æ–‡ä»¶å˜æ›´ï¼ˆå‰5ä¸ªï¼‰
          log ""
          log "ä»£ç å˜åŒ–æœ€å¤§çš„æ–‡ä»¶ (å‰5):"
          git diff --numstat "origin/$LOCAL_BRANCH" "upstream/$UPSTREAM_BRANCH" | \
            awk '{print $1+$2 "\t+" $1 "/-" $2 "\t" $3}' | \
            sort -rn | head -5 | \
            while IFS=$'\t' read -r total changes file; do
              log "  $changes  $file"
            done

      - name: æ‰§è¡ŒåŒæ­¥æ“ä½œ
        if: steps.analyze_changes.outputs.safe_to_sync == 'true'
        run: |
          LOG_FILE="${{ steps.init_protection_log.outputs.log_file }}"
          log() { echo "$@" | tee -a "$LOG_FILE"; }
          log_error() { echo "âŒ $@" | tee -a "$LOG_FILE" >&2; }
          
          log "ğŸ”„ å¼€å§‹æ‰§è¡ŒåŒæ­¥..."
          git checkout "${{ steps.detect_branches.outputs.local_branch }}"
          
          # å°è¯•åˆå¹¶ï¼Œå¦‚æœå¤±è´¥åˆ™è¾“å‡ºå†²çªæ–‡ä»¶åˆ—è¡¨
          if ! git merge --no-edit "upstream/${{ steps.detect_branches.outputs.upstream_branch }}"; then
            log_error "åˆå¹¶å†²çªï¼Œè¯·æ‰‹åŠ¨å¤„ç†ä»¥ä¸‹æ–‡ä»¶ï¼š"
            git diff --name-only --diff-filter=U | tee -a "$LOG_FILE"
            log ""
            log "ğŸ’¡ è§£å†³æ–¹æ¡ˆï¼š"
            log "  1. åœ¨ GitHub ç½‘é¡µç«¯ç‚¹å‡» 'Sync fork' æŒ‰é’®"
            log "  2. å¦‚æœ‰å†²çªï¼Œç‚¹å‡» 'Resolve conflicts' åœ¨çº¿è§£å†³"
            log "  3. æˆ–ä½¿ç”¨ GitHub Desktop å›¾å½¢ç•Œé¢å·¥å…·"
            exit 1
          fi
          
          log "âœ… åˆå¹¶æˆåŠŸ"

      - name: æ¢å¤ç”¨æˆ·è‡ªå®šä¹‰å·¥ä½œæµ
        if: steps.analyze_changes.outputs.safe_to_sync == 'true' && steps.backup_workflows.outputs.backup_count != '0'
        run: |
          BACKUP_DIR="${{ steps.backup_workflows.outputs.backup_dir }}"
          LOG_FILE="${{ steps.init_protection_log.outputs.log_file }}"
          
          log() { echo "$@" | tee -a "$LOG_FILE"; }
          
          RESTORED_COUNT=0
          
          # æ¢å¤ my-*.yml å·¥ä½œæµæ–‡ä»¶
          if [[ -d "$BACKUP_DIR" ]]; then
            for FILE in "$BACKUP_DIR"/*.yml "$BACKUP_DIR"/*.yaml; do
              if [[ -f "$FILE" ]]; then
                FILENAME=$(basename "$FILE")
                # ç¡®ä¿ç›®æ ‡ç›®å½•å­˜åœ¨
                mkdir -p ".github/workflows"
                cp -p "$FILE" ".github/workflows/$FILENAME"
                git add ".github/workflows/$FILENAME"
                RESTORED_COUNT=$((RESTORED_COUNT + 1))
                log "  æ¢å¤: $FILENAME"
              fi
            done
          fi
          
          # å¦‚æœæœ‰æ–‡ä»¶è¢«æ¢å¤ï¼Œåˆ›å»ºä¸€ä¸ªæäº¤
          if [[ $RESTORED_COUNT -gt 0 ]]; then
            if ! git diff --cached --quiet; then
              git commit -m "ğŸ›¡ï¸ ä¿æŠ¤ç”¨æˆ·è‡ªå®šä¹‰å·¥ä½œæµ (my-*.yml)"
              log "ğŸ“¦ å·²æ¢å¤ $RESTORED_COUNT ä¸ªç”¨æˆ·è‡ªå®šä¹‰å·¥ä½œæµ"
            fi
          fi

      - name: æ¨é€æ›´æ–°åˆ°Forkä»“åº“
        if: steps.analyze_changes.outputs.safe_to_sync == 'true'
        run: |
          LOG_FILE="${{ steps.init_protection_log.outputs.log_file }}"
          LOCAL_BRANCH="${{ steps.detect_branches.outputs.local_branch }}"
          
          log() { echo "$@" | tee -a "$LOG_FILE"; }
          log_success() { echo "âœ… $@" | tee -a "$LOG_FILE"; }
          log_warning() { echo "âš ï¸ $@" | tee -a "$LOG_FILE"; }
          log_error() { echo "âŒ $@" | tee -a "$LOG_FILE" >&2; }
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å®é™…çš„æäº¤éœ€è¦æ¨é€
          if git log "origin/$LOCAL_BRANCH..HEAD" --oneline | grep -q .; then
            log "ğŸ“¤ å‡†å¤‡æ¨é€æ›´æ–°..."
            
            # æ˜¾ç¤ºå³å°†æ¨é€çš„æäº¤
            COMMIT_COUNT=$(git log "origin/$LOCAL_BRANCH..HEAD" --oneline | wc -l)
            log "å³å°†æ¨é€ $COMMIT_COUNT ä¸ªæäº¤:"
            git log "origin/$LOCAL_BRANCH..HEAD" --oneline | tee -a "$LOG_FILE"
            
            # æ‰§è¡Œæ¨é€
            if git push origin "$LOCAL_BRANCH"; then
              log_success "åŒæ­¥æˆåŠŸå®Œæˆï¼"
              log ""
              log "ğŸ“Š åŒæ­¥ç»Ÿè®¡:"
              log "  - åˆ é™¤æ–‡ä»¶: ${{ steps.analyze_changes.outputs.deleted_count }}"
              log "  - æ–°å¢æ–‡ä»¶: ${{ steps.analyze_changes.outputs.added_count }}"
              log "  - ä¿®æ”¹æ–‡ä»¶: ${{ steps.analyze_changes.outputs.modified_count }}"
              log "  - ä»£ç å˜åŒ–: +${{ steps.analyze_changes.outputs.lines_added }}/-${{ steps.analyze_changes.outputs.lines_deleted }} è¡Œ"
              log "  - READMEå˜åŒ–: ${{ steps.analyze_changes.outputs.readme_change_percent }}%"
              log "  - æ¨é€æäº¤: $COMMIT_COUNT ä¸ª"
              log ""
              log "ğŸ›¡ï¸ å·¥ä½œæµä¿æŠ¤ç­–ç•¥:"
              log "  - my-*.yml æ–‡ä»¶å·²ä¿æŠ¤ï¼ˆç”¨æˆ·è‡ªå®šä¹‰ï¼‰"
              log "  - å…¶ä»–å·¥ä½œæµè·Ÿéšä¸Šæ¸¸æ›´æ–°"
            else
              log_error "æ¨é€å¤±è´¥ï¼Œè¯·æ£€æŸ¥æƒé™å’Œç½‘ç»œè¿æ¥"
              exit 1
            fi
          else
            log_warning "æ²¡æœ‰éœ€è¦æ¨é€çš„æ–°æäº¤"
            log "â„¹ï¸ æœ¬åœ°å·²æ˜¯æœ€æ–°çŠ¶æ€ï¼Œæ— éœ€æ¨é€"
          fi

      - name: åŒæ­¥è¢«é˜»æ­¢ï¼ˆå®‰å…¨ä¿æŠ¤è§¦å‘ï¼‰
        if: steps.analyze_changes.outputs.safe_to_sync == 'false'
        run: |
          echo "::error::ğŸš« åŒæ­¥è¢«æ™ºèƒ½ä¿æŠ¤é˜»æ­¢"
          echo ""
          echo "===== ğŸš« åŒæ­¥è¢«å®‰å…¨ä¿æŠ¤é˜»æ­¢ ====="
          echo ""
          echo "ğŸ“Š è¯¦ç»†ç»Ÿè®¡:"
          echo "  æ–‡ä»¶å˜åŒ–:"
          echo "    - åˆ é™¤æ–‡ä»¶: ${{ steps.analyze_changes.outputs.deleted_count }} (${{ steps.analyze_changes.outputs.delete_ratio }}%)"
          echo "    - æ–°å¢æ–‡ä»¶: ${{ steps.analyze_changes.outputs.added_count }}"
          echo "    - ä¿®æ”¹æ–‡ä»¶: ${{ steps.analyze_changes.outputs.modified_count }}"
          echo "    - å…³é”®æ–‡ä»¶åˆ é™¤: ${{ steps.analyze_changes.outputs.critical_deleted }}"
          echo ""
          echo "  ä»£ç å˜åŒ–:"
          echo "    - æ–°å¢è¡Œæ•°: +${{ steps.analyze_changes.outputs.lines_added }}"
          echo "    - åˆ é™¤è¡Œæ•°: -${{ steps.analyze_changes.outputs.lines_deleted }}"
          echo "    - æ€»å˜åŒ–è¡Œæ•°: ${{ steps.analyze_changes.outputs.lines_changed }}"
          echo ""
          echo "  README å˜åŒ–:"
          echo "    - å˜åŒ–æ¯”ä¾‹: ${{ steps.analyze_changes.outputs.readme_change_percent }}%"
          echo ""
          echo "  å˜åŒ–ç‡:"
          echo "    - æ–‡ä»¶å˜åŒ–ç‡: ${{ steps.analyze_changes.outputs.change_ratio }}%"
          echo ""
          echo "ğŸ›¡ï¸ è§¦å‘çš„ä¿æŠ¤æœºåˆ¶:"
          echo "${{ steps.analyze_changes.outputs.block_reason }}"
          echo ""
          echo "ğŸ’¡ è§£å†³æ–¹æ¡ˆ:"
          echo "  1. æŸ¥çœ‹ä¸Šæ¸¸ä»“åº“çš„å˜æ›´: https://github.com/${{ env.UPSTREAM_REPO }}/commits"
          echo "  2. å¦‚ç¡®è®¤å˜æ›´å®‰å…¨ï¼Œæ‰‹åŠ¨è¿è¡Œå·¥ä½œæµå¹¶å‹¾é€‰ 'force_sync' é€‰é¡¹"
          echo "  3. æˆ–åœ¨ GitHub ç½‘é¡µç«¯æ‰‹åŠ¨åŒæ­¥"
          echo ""
          echo "ğŸ“– è¯¦ç»†æ—¥å¿—å·²ä¿å­˜ï¼Œè¯·æŸ¥çœ‹ Artifacts ä¸­çš„ sync-protection-log"
          echo ""
          # ç¡®ä¿ä»¥å¤±è´¥çŠ¶æ€é€€å‡ºï¼Œæ˜¾ç¤ºçº¢è‰²âŒ
          exit 1

      - name: ä¸Šä¼ åŒæ­¥æ—¥å¿—
        if: always() && steps.init_protection_log.outputs.log_file != ''
        uses: actions/upload-artifact@v4
        with:
          name: sync-protection-log-${{ github.run_id }}
          path: ${{ steps.init_protection_log.outputs.log_file }}
          retention-days: 30
